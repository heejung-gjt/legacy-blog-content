<!DOCTYPE html>
<html>
<head>


    <!-- Document Settings -->
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />


    <!--syntax.css 추가-->
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />

    <!--font awesome-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <!--font -->
    <link rel="preconnect" href="https://fonts.gstatic.com">

    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&family=Source+Sans+Pro:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- custom.css -->
    <link rel="stylesheet" type="text/css" href="/assets/built/custom.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
    
    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="개발 공부하는 블로그" />
    <link rel="shortcut icon" href="https://heejung-gjt.github.io/assets/built/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://heejung-gjt.github.io/django-project1" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="studying developer" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="중고 쇼핑몰 프로젝트 회고 및 리팩토링 후기" />
    <meta property="og:description" content="6월에 시작한 첫번째 개인 프로젝트였다. 꾸준히 기능적인 부분을 업데이트 시켜왔었지만 정작 짜왔던 코드를 스스로 리뷰해보는 시간을 가져보지 못했다. 이런 생각이 든 후 과거에 짜왔던 로직을 다시한번 보게 되었고 느낀점이 많았다. 😂😂 가장 먼저 가독성이 좋지 않음을 느끼게 되었다. 물론 2-3개월 지났지만 특정 기능의 로직을 파악하는데 시간이 꽤 걸렸다. 굳이 필요하지" />
    <meta property="og:url" content="https://heejung-gjt.github.io/django-project1" />
    <meta property="og:image" content="https://heejung-gjt.github.io/assets/built/images/today.png" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2021-09-15T17:40:00+09:00" />
    <meta property="article:modified_time" content="2021-09-15T17:40:00+09:00" />
    <meta property="article:tag" content="Project" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="중고 쇼핑몰 프로젝트 회고 및 리팩토링 후기" />
    <meta name="twitter:description" content="6월에 시작한 첫번째 개인 프로젝트였다. 꾸준히 기능적인 부분을 업데이트 시켜왔었지만 정작 짜왔던 코드를 스스로 리뷰해보는 시간을 가져보지 못했다. 이런 생각이 든 후 과거에 짜왔던 로직을 다시한번 보게 되었고 느낀점이 많았다. 😂😂 가장 먼저 가독성이 좋지 않음을 느끼게 되었다. 물론 2-3개월 지났지만 특정 기능의 로직을 파악하는데 시간이 꽤 걸렸다. 굳이 필요하지" />
    <meta name="twitter:url" content="https://heejung-gjt.github.io/" />
    <meta name="twitter:image" content="https://heejung-gjt.github.io/assets/built/images/today.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="studying developer" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Project" />
    <meta name="twitter:site" content="@" />
    <meta name="twitter:creator" content="@" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "studying developer",
        "logo": "https://heejung-gjt.github.io/"
    },
    "url": "https://heejung-gjt.github.io/django-project1",
    "image": {
        "@type": "ImageObject",
        "url": "https://heejung-gjt.github.io/assets/built/images/today.png",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://heejung-gjt.github.io/django-project1"
    },
    "description": "6월에 시작한 첫번째 개인 프로젝트였다. 꾸준히 기능적인 부분을 업데이트 시켜왔었지만 정작 짜왔던 코드를 스스로 리뷰해보는 시간을 가져보지 못했다. 이런 생각이 든 후 과거에 짜왔던 로직을 다시한번 보게 되었고 느낀점이 많았다. 😂😂 가장 먼저 가독성이 좋지 않음을 느끼게 되었다. 물론 2-3개월 지났지만 특정 기능의 로직을 파악하는데 시간이 꽤 걸렸다. 굳이 필요하지"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="중고 쇼핑몰 프로젝트 회고 및 리팩토링 후기" href="/feed.xml" />

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LESPMGXKR3"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-LESPMGXKR3');
</script>
</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://heejung-gjt.github.io/">studying developer</a>
            
        
        
            
<ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <!-- <li class="nav-about" role="menuitem"><a href="/about/">About</a></li> -->
    <li class="nav-jekyll" role="menuitem"><a href="/tag/wanted/">원티드</a></li>
    <li class="nav-jekyll" role="menuitem"><a href="/tag/project/">프로젝트TIL</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/js/">JavaScript</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/python/">Python</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/django/">Django</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/celery/">Celery</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/rabbitmq/">RabbitMQ</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/oauth/">OAuth</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/jwt/">JWT</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/cors/">CORS</a></li>
    <li class="nav-jekyll" role="menuitem"><a href="/tag/linux/">linux</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/algorithm/">algorithm</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/network/">Network</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/os/">OS</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/database/">DataBase</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/aws/">AWS</a></li>
    <li class="nav-jekyll" role="menuitem"><a href="/tag/git/">Git</a></li>
    <li class="nav-jekyll" role="menuitem"><a href="/tag/til/">TIL</a></li>
    <li class="nav-jekyll" role="menuitem" style="display: none" ><a href="/tag/wecode/">위코드</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/coding/">코테</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/interview/">면접</a></li>
<!--    <li class="nav-jekyll" role="menuitem" style="display: none" ><a href="/tag/aimmo/">에이모</a></li>-->
<!--    <li class="nav-archive" role="menuitem">-->
<!--        <a href="_includes/archive.html">All Posts</a>-->
<!--    </li>-->
</ul>
        
    </div>
    <!-- subscribe 안함
    <div class="site-nav-right">
        <div class="social-links">
            
            
        </div>
        
            <a class="subscribe-button" href="#subscribe">Subscribe</a>
        
    </div>-->
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-project tag-refactoring post tag project ">

            <header class="post-full-header">

              <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="2021-09-15">2021-09-15</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/project/'>PROJECT</a>,
                            
                        
                            
                               <a href='/tag/refactoring/'>REFACTORING</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">중고 쇼핑몰 프로젝트 회고 및 리팩토링 후기</h1>
            </header>

<!--  
            
            <figure class="post-full-image" style="background-image: url(/assets/built/images/today.png)">
            </figure>
            
-->

            <section class="post-full-content">

                <div class="kg-card-markdown">

                    
<p><br /></p>

<p>6월에 시작한 첫번째 개인 프로젝트였다. 꾸준히 <a href="https://github.com/heejung-gjt/market/wiki/v1.0">기능적인 부분을 업데이트</a> 시켜왔었지만 정작 짜왔던 코드를 스스로 리뷰해보는
시간을 가져보지 못했다. 이런 생각이 든 후 과거에 짜왔던 로직을 다시한번 보게 되었고 느낀점이 많았다. 😂😂</p>

<p>가장 먼저 가독성이 좋지 않음을 느끼게 되었다. 물론 2-3개월 지났지만 특정 기능의 로직을 파악하는데 시간이 꽤 걸렸다.<br />
굳이 필요하지 않은 코드도 존재해 보였다. (코드가 전체적으로 이뻐보이지 않았다.. :-( ) <br />
무엇보다 필터링 기능에 있어 제품을 필터링 한 후 페이지 번호를 선택하면 랜더링이 되면서 필터된 제품이 아닌 모든 제품이 보여지는 것을 
파악하게 되었다..(제대로 테스트를 해보지 않은 내 잘못이였다..)</p>

<p>리팩토링이 필요했던 또 다른 이유로 화면의 로딩이 1-2초 지연되는 답답한 상황이 있었다.</p>

<p>이러한 이유로 리팩토링을 진행하게 되었다.</p>

<hr />

<ul>
  <li><strong>제품 필터링 GET 메소드 요청</strong></li>
</ul>

<p>리팩토링의 1차적인 목표는 <code class="highlighter-rouge">가독성</code> 이다. 코드의 가독성이 좋지 않으면 코드를 짠 나조차도 사실 코드 보기가 싫어진다. <br />
2차적인 목표는 코드의 <code class="highlighter-rouge">일관성</code> 이다. 기존의 코드를 보면 어떤건 서비스 레이어 로직으로 작성하고 어떤건 view에 하드코딩을 했다. 한 사람이 짰지만
마치 여러사람이 짠 것처럼 느껴졌다.</p>

<p>초반에 필터링 된 기능을 구현할때 post 메소드를 이용했다. 하지만 제품 필터 기능은 GET방식이 좀 더 알맞은 것 같아 메소드를 GET으로 수정했다. 
SelectView의 view를 보면 정확히 어떤 기능을 하는지 알 수 없었다. 데이터는 dto를 사용해 데이터를 view에서 유저가 요청한 
제품을 필터하는 로직을 따로 분리하고 싶었다.</p>

<blockquote>
  <p><a href="https://github.com/heejung-gjt/market/blob/37473f91880efeda74b8f92c912292e44ca06617/product/views.py">리팩토링 전 코드보기</a> <br />
<a href="https://github.com/heejung-gjt/market/blob/main/product/views.py">리팩토링 후 코드보기</a></p>
</blockquote>

<p>초반의 제품을 필터링 하는 코드를 보면 view안에서 데이터를 get해오고 Q객체를 사용해 요청한 데이터를 기준으로 제품을 필터링 해오고 페이징 처리후 결과값을 반환해주었다. 
데이터를 get해오는 로직과 제품을 필터링 하는 로직이 길다보니까 가독성이 좋지 못했다.</p>

<p>SelectView라는 class의 네이밍도 어떤 역할을 하는 기능인지 추축하기 어려웠다.</p>

<ul>
  <li>요청받은 필터된 데이터 불러오기</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SelectView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">categorys</span> <span class="o">=</span> <span class="n">ProductFilterService</span><span class="o">.</span><span class="n">find_by_all_category</span><span class="p">()</span>
    <span class="n">category</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'sub-menu-pk'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">price_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'price-start'</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">price_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'price-end'</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">)</span>
    <span class="n">product_sort</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'sort'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">price_from</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">price_from</span><span class="p">)</span>
    <span class="n">price_to</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">price_to</span><span class="p">)</span>
    <span class="n">articles</span> <span class="o">=</span> <span class="bp">None</span>
</code></pre></div></div>

<ul>
  <li>Q객체 이용해 필터된 제품 객체 필터하기</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
      <span class="n">q</span> <span class="o">&amp;=</span> <span class="n">Q</span><span class="p">(</span><span class="n">category</span> <span class="o">=</span> <span class="n">category</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">&amp;=</span> <span class="n">Q</span><span class="p">(</span><span class="n">price__range</span> <span class="o">=</span><span class="p">(</span><span class="n">price_from</span><span class="p">,</span> <span class="n">price_to</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">product_sort</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">product_sort</span> <span class="o">==</span> <span class="s">'1'</span><span class="p">:</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-created_at'</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">product_sort</span> <span class="o">==</span> <span class="s">'2'</span><span class="p">:</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'created_at'</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">product_sort</span> <span class="o">==</span> <span class="s">'3'</span><span class="p">:</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'price'</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">product_sort</span> <span class="o">==</span> <span class="s">'4'</span><span class="p">:</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-price'</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">product_sort</span> <span class="o">==</span> <span class="s">'5'</span><span class="p">:</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">is_deleted</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">like_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">'like__users'</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-like_count'</span><span class="p">,</span><span class="s">'-created_at'</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">product_sort</span> <span class="o">==</span> <span class="s">'6'</span><span class="p">:</span>
        <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">is_deleted</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">review_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">'comment'</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-review_count'</span><span class="p">,</span><span class="s">'-created_at'</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">articles</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-created_at'</span><span class="p">)</span>
</code></pre></div></div>

<ul>
  <li>필터된 제품 페이징 처리 한 후 값 반환하기</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'page'</span><span class="p">,</span> <span class="s">'1'</span><span class="p">)</span>
    <span class="n">articles</span><span class="p">,</span> <span class="n">page_range</span> <span class="o">=</span> <span class="n">paginator</span><span class="p">(</span><span class="n">articles</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">'sort'</span><span class="p">:</span><span class="n">product_sort</span><span class="p">,</span><span class="s">'pk'</span><span class="p">:</span><span class="n">category</span><span class="p">,</span><span class="s">'start'</span><span class="p">:</span><span class="n">price_from</span><span class="p">,</span><span class="s">'end'</span><span class="p">:</span><span class="n">price_to</span><span class="p">,</span> <span class="s">'article_list'</span><span class="p">:</span><span class="n">articles</span><span class="p">,</span><span class="s">'category_list'</span><span class="p">:</span><span class="n">categorys</span><span class="p">,</span><span class="s">'is_page'</span><span class="p">:</span><span class="bp">False</span><span class="p">,</span><span class="s">'page_range'</span><span class="p">:</span><span class="n">page_range</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'article.html'</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<ul>
  <li>dto로 요청받는 데이터를 사전에 정하고 메소드로 데이터를 data라는 변수로 받게 처리했다</li>
  <li>ProductFilterService 서비스로직의 get_filter_product_infor메소드에서 제품을 필터하는 로직을 따로 빼서 작성했다.</li>
  <li>해당 메소드를 거쳐 페이징 처리된 필터링 제품을 view의 context에서 받게된다</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FilterProductView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_product_filter_dto</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">ProductFilterService</span><span class="o">.</span><span class="n">get_filter_product_infor</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'article.html'</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_product_filter_dto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">ProductFilterDto</span><span class="p">(</span>
            <span class="n">category_pk</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'sub-menu-pk'</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
            <span class="n">price_from</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'price-start'</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">price_to</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'price-end'</span><span class="p">,</span> <span class="mi">10000000</span><span class="p">),</span>
            <span class="n">product_sort</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'sort'</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<hr />

<h3 id="쿼리-최적화">쿼리 최적화</h3>

<p>제품이 렌더링 되어지는 화면의 로딩이 느린 문제가 발생했다. 로직에 문제가 있나 싶어 느려질 수 있는 로직 부분을 찾아보았으나 별 다른 문제가 없어보였다. 이를 해결하기 위해 <code class="highlighter-rouge">django-debug-toolbar</code> 를 설치하였고 이를 통해 페이지가 로딩되면서 발생하는 쿼리를 확인해 볼 수 있었다.</p>

<p>그 결과 3개의 데이터를 조회하는데 중복과 비슷한 쿼리가 굉장히 많이 발생하는 것을 볼 수 있었다.</p>

<p><img src="https://user-images.githubusercontent.com/64240637/137748777-0da2d831-81d9-4832-a09e-8a5f0ecb0eea.png" alt="marketsqltoolbar" /></p>

<p>중복되는 쿼리문을 줄이기 위해 <code class="highlighter-rouge">select_related()</code> , <code class="highlighter-rouge">prefetch_related()</code> 메소드를 활용하였다. 그 결과 10개의 쿼리문으로 줄일 수 있게 되었고 중복과 비슷한 쿼리문을 모두 제거할 수 있게 되었다. 카테고리별 화면도 대부분 메인 화면에서 발생하는 문제와 비슷하였고 똑같이 해결 할 수 있었다.</p>

<ul>
  <li>
    <p>장고 템플릿에서 이미지 한장을 화면에 렌더링 시키기 위해 first라는 구문을 사용했는데 첫번째 이미지를 찾기 위해 쿼리가 발생하는 듯 보였다. templatetag폴더에 get_one_image라는 파일을 만들어 <code class="highlighter-rouge">photo = photo.all()[0].image</code> 로 첫번째의 이미지를 가져왔다(view에서 prefetch_related(‘photo’)를 작성해 photo에 관련된 모델을 미리 로딩시켰기 때문에 다시 쿼리를 발생 시키지 않는다)</p>
  </li>
  <li>
    <p>article 인스턴스별로 article과 N:M, 1:N 관계인 모델에 접근해야 했기 때문에 많은 중복 쿼리가 발생했지만 <code class="highlighter-rouge">Article.objects.filter(is_deleted = False).prefetch_related('photo', 'comment').select_related('writer', 'address', 'category', 'article_price','like')</code> 로 대부분의 중복 쿼리가 해결되었다. 미리 관련 모델을 로딩했기 때문에 추가로 돌아가는 쿼리가 없게 된다.</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">q</span> <span class="o">=</span> <span class="n">Q</span><span class="p">()</span>

<span class="k">if</span> <span class="n">dto</span><span class="o">.</span><span class="n">category_pk</span><span class="p">:</span>
   <span class="n">q</span> <span class="o">&amp;=</span> <span class="n">Q</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="n">dto</span><span class="o">.</span><span class="n">category_pk</span><span class="p">)</span>
   <span class="n">q</span> <span class="o">&amp;=</span> <span class="n">Q</span><span class="p">(</span><span class="n">price__range</span><span class="o">=</span><span class="p">(</span><span class="n">price_from</span><span class="p">,</span> <span class="n">price_to</span><span class="p">))</span>

 <span class="k">if</span> <span class="n">dto</span><span class="o">.</span><span class="n">product_sort</span><span class="p">:</span>
            <span class="n">articles_filter</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="s">'photo'</span><span class="p">,</span> <span class="s">'comment'</span><span class="p">)</span><span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s">'writer'</span><span class="p">,</span> <span class="s">'article_price'</span><span class="p">,</span> <span class="s">'like'</span> <span class="p">,</span><span class="s">'address'</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">dto</span><span class="o">.</span><span class="n">product_sort</span> <span class="o">==</span> <span class="s">'1'</span><span class="p">:</span>
                <span class="n">articles</span> <span class="o">=</span> <span class="n">articles_filter</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-created_at'</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dto</span><span class="o">.</span><span class="n">product_sort</span> <span class="o">==</span> <span class="s">'2'</span><span class="p">:</span>
                <span class="n">articles</span> <span class="o">=</span> <span class="n">articles_filter</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'created_at'</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dto</span><span class="o">.</span><span class="n">product_sort</span> <span class="o">==</span> <span class="s">'3'</span><span class="p">:</span>
                <span class="n">articles</span> <span class="o">=</span> <span class="n">articles_filter</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'price'</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dto</span><span class="o">.</span><span class="n">product_sort</span> <span class="o">==</span> <span class="s">'4'</span><span class="p">:</span>
                <span class="n">articles</span> <span class="o">=</span> <span class="n">articles_filter</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-price'</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dto</span><span class="o">.</span><span class="n">product_sort</span> <span class="o">==</span> <span class="s">'5'</span><span class="p">:</span>
                <span class="n">articles</span> <span class="o">=</span> <span class="n">articles_filter</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">like_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">'like__users'</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-like_count'</span><span class="p">,</span><span class="s">'-created_at'</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">dto</span><span class="o">.</span><span class="n">product_sort</span> <span class="o">==</span> <span class="s">'6'</span><span class="p">:</span>
                <span class="n">articles</span> <span class="o">=</span> <span class="n">articles_filter</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">review_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s">'comment'</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-review_count'</span><span class="p">,</span><span class="s">'-created_at'</span><span class="p">)</span>

<span class="k">else</span><span class="p">:</span>
    <span class="n">articles</span> <span class="o">=</span> <span class="n">articles_filter</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">'-created_at'</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<p>그 결과 아래와 같이 쿼리를 중복해서 접근하는 경우가 사라졌고 쿼리 접근 횟수가 줄어든 것을 볼 수 있었다  <br />
<img src="https://user-images.githubusercontent.com/64240637/137749383-c3e9414d-0b61-4c87-8370-df577b1be9d3.png" alt="gorf" /></p>

<hr />

<h3 id="project-introduction">Project Introduction</h3>

<p>장고의 기본적인 CRUD와 다양한 기능을 구현해보기 위해서 중고 쇼핑몰 사이트를 선택했습니다. 실제 유저가 사용할 수 있는 완성도로 개발하기 위해 여전히 진행중에 있습니다.</p>

<blockquote>
  <p>초기 프로젝트 진행 인원 수 : 개인  <br />
개발 기간 : v1.0 2021.06.03 ~ 2021.06.17</p>
</blockquote>

<blockquote>
  <p>후기 리팩토링 프로젝트 진행 : 개인  <br />
개발 기간 : v2.0 2021.08.05 ~ 2021.09.26  <br />
리팩토링 된 기능 : 서비스 레이어 로직으로 변경, 필터 기능 POST -&gt; GET 메소드 변경, USER 상속</p>
</blockquote>

<blockquote>
  <p>개발 기간 : v2.1 2021.10.11 ~ 2021.10.25
리팩토링 된 기능 : 여러이미지 S3에 업로드 기능</p>
</blockquote>

<blockquote>
  <p>GitHub Respository  <br />
   Github <a href="https://github.com/heejung-gjt/market">Repo</a></p>
</blockquote>


                </div>
<!--                -->
<!--                -->
<!--                <span class="tag">project</span>-->
<!--                -->
<!--                <span class="tag">refactoring</span>-->
<!--                -->
<!--                -->
            </section>
        
        <div id="post-disqus" class="container">
            <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://heejung-gjt-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        </div>
        



    </div>
</main>

        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://heejung-gjt.github.io/">studying developer</a> &copy; 2021</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://github.com/heejung-gjt" target="_blank" rel="noopener">heejung's GitHub Pages</a>
<!--                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener"></a>-->
                </section>
                <nav class="site-footer-nav">
<!--                    <a href="/">Latest Posts</a>-->
                    
                    
                    <a href="https://heejung-gjt.github.io" target="_blank" rel="noopener">github blog</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    
        <div id="subscribe" class="subscribe-overlay">
            <a class="subscribe-overlay-close" href="#"></a>
            <div class="subscribe-overlay-content">
                
                <h1 class="subscribe-overlay-title">Subscribe to studying developer</h1>
                <p class="subscribe-overlay-description">Stay up to date! Get all the latest &amp; greatest posts delivered straight to your inbox</p>
<!--                <!--
<form method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  /><input class="location" type="hidden" name="location"  /><input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" type="email" name="email"  placeholder="youremail@example.com" />
    </div>
    <button class="" type="submit" disabled><span>Subscribe</span></button>
    <script type="text/javascript">(function(g,h,o,s,t){h[o]('.location')[s]=h[o]('.location')[s] || g.location.href;h[o]('.referrer')[s]=h[o]('.referrer')[s] || h.referrer;})(window,document,'querySelector','value');</script>
</form>
-->-->
            </div>
        </div>
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'G-LESPMGXKR3', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->
    <script id="dsq-count-scr" src="//heejung-gjt-github-io.disqus.com/count.js" async></script>
</body>
</html>
