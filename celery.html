<!DOCTYPE html>
<html>
<head>


    <!-- Document Settings -->
    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />


    <!--syntax.css 추가-->
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />

    <!--font awesome-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <!--font -->
    <link rel="preconnect" href="https://fonts.gstatic.com">

    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic&family=Source+Sans+Pro:wght@300;400;600&display=swap" rel="stylesheet">
    <!-- custom.css -->
    <link rel="stylesheet" type="text/css" href="/assets/built/custom.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
    
    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="개발 공부하는 블로그" />
    <link rel="shortcut icon" href="https://heejung-gjt.github.io/assets/built/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://heejung-gjt.github.io/celery" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="studying developer" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Celery, RabbitMQ 이용해 비동기 처리하기" />
    <meta property="og:description" content="Celery Celery는 비동기 작업을 처리할 수 있도록 해주는 비동기 작업 큐이다. 비동기적으로 실행되야 할 때 사용된다 celery는 웹서버-브로커-워커 이세가지와 상호작용을 한다 celery에서는 작업 메시지를 브로커에게 전달한다. rabbitmq 대기중인 작업을 대기열에 보관했다가 적절한 worker에게 작업을 전달해주는 역할을 한다 rabbitmq는 celery 와 함께 사용하는 메시지 브로커이다 broker가 필요한 이유 : 셀러리는 실제로" />
    <meta property="og:url" content="https://heejung-gjt.github.io/celery" />
    <meta property="og:image" content="https://heejung-gjt.github.io/assets/built/images/celery.png" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:author" content="https://www.facebook.com/" />
    <meta property="article:published_time" content="2021-08-04T13:05:00+09:00" />
    <meta property="article:modified_time" content="2021-08-04T13:05:00+09:00" />
    <meta property="article:tag" content="Celery" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Celery, RabbitMQ 이용해 비동기 처리하기" />
    <meta name="twitter:description" content="Celery Celery는 비동기 작업을 처리할 수 있도록 해주는 비동기 작업 큐이다. 비동기적으로 실행되야 할 때 사용된다 celery는 웹서버-브로커-워커 이세가지와 상호작용을 한다 celery에서는 작업 메시지를 브로커에게 전달한다. rabbitmq 대기중인 작업을 대기열에 보관했다가 적절한 worker에게 작업을 전달해주는 역할을 한다 rabbitmq는 celery 와 함께 사용하는 메시지 브로커이다 broker가 필요한 이유 : 셀러리는 실제로" />
    <meta name="twitter:url" content="https://heejung-gjt.github.io/" />
    <meta name="twitter:image" content="https://heejung-gjt.github.io/assets/built/images/celery.png" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="studying developer" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Celery" />
    <meta name="twitter:site" content="@" />
    <meta name="twitter:creator" content="@" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "studying developer",
        "logo": "https://heejung-gjt.github.io/"
    },
    "url": "https://heejung-gjt.github.io/celery",
    "image": {
        "@type": "ImageObject",
        "url": "https://heejung-gjt.github.io/assets/built/images/celery.png",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://heejung-gjt.github.io/celery"
    },
    "description": "Celery Celery는 비동기 작업을 처리할 수 있도록 해주는 비동기 작업 큐이다. 비동기적으로 실행되야 할 때 사용된다 celery는 웹서버-브로커-워커 이세가지와 상호작용을 한다 celery에서는 작업 메시지를 브로커에게 전달한다. rabbitmq 대기중인 작업을 대기열에 보관했다가 적절한 worker에게 작업을 전달해주는 역할을 한다 rabbitmq는 celery 와 함께 사용하는 메시지 브로커이다 broker가 필요한 이유 : 셀러리는 실제로"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="Celery, RabbitMQ 이용해 비동기 처리하기" href="/feed.xml" />

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LESPMGXKR3"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-LESPMGXKR3');
</script>
</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://heejung-gjt.github.io/">studying developer</a>
            
        
        
            
<ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <!-- <li class="nav-about" role="menuitem"><a href="/about/">About</a></li> -->
    <li class="nav-jekyll" role="menuitem"><a href="/tag/wanted/">원티드</a></li>
    <li class="nav-jekyll" role="menuitem"><a href="/tag/project/">프로젝트TIL</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/js/">JavaScript</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/python/">Python</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/django/">Django</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/celery/">Celery</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/rabbitmq/">RabbitMQ</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/oauth/">OAuth</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/jwt/">JWT</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/cors/">CORS</a></li>
    <li class="nav-jekyll" role="menuitem"><a href="/tag/linux/">linux</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/algorithm/">algorithm</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/network/">Network</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/os/">OS</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/database/">DataBase</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/aws/">AWS</a></li>
    <li class="nav-jekyll" role="menuitem"><a href="/tag/git/">Git</a></li>
    <li class="nav-jekyll" role="menuitem"><a href="/tag/til/">TIL</a></li>
    <li class="nav-jekyll" role="menuitem" style="display: none" ><a href="/tag/wecode/">위코드</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/coding/">코테</a></li>
    <li class="nav-python" role="menuitem"><a href="/tag/interview/">면접</a></li>
<!--    <li class="nav-jekyll" role="menuitem" style="display: none" ><a href="/tag/aimmo/">에이모</a></li>-->
<!--    <li class="nav-archive" role="menuitem">-->
<!--        <a href="_includes/archive.html">All Posts</a>-->
<!--    </li>-->
</ul>
        
    </div>
    <!-- subscribe 안함
    <div class="site-nav-right">
        <div class="social-links">
            
            
        </div>
        
            <a class="subscribe-button" href="#subscribe">Subscribe</a>
        
    </div>-->
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-celery post tag celery ">

            <header class="post-full-header">

              <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="2021-08-04">2021-08-04</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/celery/'>CELERY</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">Celery, RabbitMQ 이용해 비동기 처리하기</h1>
            </header>

<!--  
            
            <figure class="post-full-image" style="background-image: url(/assets/built/images/celery.png)">
            </figure>
            
-->

            <section class="post-full-content">

                <div class="kg-card-markdown">

                    
<p><br /></p>

<h3 id="celery">Celery</h3>

<p>Celery는 비동기 작업을 처리할 수 있도록 해주는 비동기 작업 큐이다. 비동기적으로 실행되야 할 때 사용된다</p>

<p>celery는 웹서버-브로커-워커 이세가지와 상호작용을 한다</p>

<p>celery에서는 작업 메시지를 브로커에게 전달한다.</p>

<hr />

<h3 id="rabbitmq">rabbitmq</h3>

<p>대기중인 작업을 대기열에 보관했다가 적절한 worker에게 작업을 전달해주는 역할을 한다</p>

<p>rabbitmq는 celery 와 함께 사용하는 메시지 브로커이다</p>

<p><strong>broker가 필요한 이유</strong> : 셀러리는 실제로 메시지 큐 자체를 구성하는 것은 아니기 때문에 이 작업을 수행하기위해서 추가 메시지 전송이 필요하다. 셀러리는 메시지 브로커를 감싸는 래퍼로 생각할 수 있다</p>

<hr />

<h3 id="worker">worker</h3>

<p>worker에서는 해당 작업을 가져와 수행하게 된다. 이과정에서 celery는 메시지를 전달하는 역할과 메시지를 가져와 작업을 수행하는 역할을 담당하게 된다.</p>

<hr />

<h3 id="celery-설치--rabbitmq설치">celery 설치 &amp; rabbitMQ설치</h3>

<ul>
  <li>Celery 패키지 설치</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">celery</span>
</code></pre></div></div>

<p><br /></p>

<ul>
  <li>celery django에서 실행
    <ul>
      <li>django에서 쓰기 위해 celery instance를 정의한다</li>
      <li>app.autodiscover_tasks()를 정의하여 Celery에서 자동으로 Task들을 찾아낸다</li>
      <li>Celery는 shared_task라는 테코레이터를 제공하고 Task에 @shared_task 데코레이터를 붙여 비동기적으로 처리 될 수 있도록 한다</li>
    </ul>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># config/celery.py</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">celery</span> <span class="kn">import</span> <span class="n">Celery</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s">'DJANGO_SETTINGS_MODULE'</span><span class="p">,</span> <span class="s">'config.settings'</span><span class="p">)</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Celery</span><span class="p">(</span><span class="s">'config'</span><span class="p">,</span> <span class="n">broker</span><span class="o">=</span><span class="s">'amqp://'</span><span class="p">,</span> <span class="n">backend</span><span class="o">=</span><span class="s">'rpc://'</span><span class="p">,</span> <span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s">'user.tasks'</span><span class="p">])</span>
<span class="n">app</span><span class="o">.</span><span class="n">config_from_object</span><span class="p">(</span><span class="s">'django.conf:settings'</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s">'CELERY'</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">autodiscover_tasks</span><span class="p">()</span>

<span class="nd">@app.task</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">debug_task</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Request: {0!r}'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">))</span>
</code></pre></div></div>

<p><br /></p>

<ul>
  <li>Celery 실행확인
    <ul>
      <li>flower라는 패키지 설치</li>
      <li>flower는 celery를 위한 실시간 웹 기반 모니터입니다. 작업 진행 상황과 기록을 쉽게 모니터링 할 수 있습니다 (http://localhost:5555 에서 액세스)</li>
    </ul>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">flower</span>

<span class="err">$</span> <span class="n">celery</span> <span class="o">-</span><span class="n">A</span> <span class="n">config</span> <span class="n">flower</span>
</code></pre></div></div>

<p><br /></p>

<ul>
  <li>rabbimq 설치</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">serve</span>
</code></pre></div></div>

<p><br /></p>

<ul>
  <li>celery가 접근할 수 있도록 user를 생성한다 (기존 guest 삭제)</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">sudo</span> <span class="n">rabbitmqctl</span> <span class="n">add_user</span> <span class="o">&lt;</span><span class="n">user</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">pwd</span><span class="o">&gt;</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">rabbitmqctl</span> <span class="n">set_user_tags</span> <span class="o">&lt;</span><span class="n">user</span><span class="o">&gt;</span> <span class="n">administrator</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="n">rabbitmqctl</span> <span class="n">set_permissions</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span> <span class="o">&lt;</span><span class="n">user</span><span class="o">&gt;</span> <span class="s">".*"".*"</span> <span class="s">".*"</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">sudo</span> <span class="n">rabbitmqctl</span> <span class="n">delete_user</span> <span class="n">guest</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span> <span class="n">restart</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">sudo</span> <span class="n">rabbitmq</span><span class="o">-</span><span class="n">plugins</span> <span class="n">enable</span> <span class="n">rabbitmq_management</span>
<span class="err">$</span> <span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">server</span> <span class="n">restart</span>
</code></pre></div></div>

<ul>
  <li>모니터링 확인 방법
    <ul>
      <li><a href="http://127.0.0.1:15672">http://127.0.0.1:15672</a> 로 확인</li>
    </ul>
  </li>
</ul>

<hr />

<ul>
  <li>celery와 broker를 연결하기 위해 settings.py에서 BROKER_URL을 입력하여 연결한다</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># config/settings</span>

<span class="n">CELERY_BROKER_URL</span> <span class="o">=</span> <span class="n">env</span><span class="p">(</span><span class="s">'CELERY_BROKER_URL'</span><span class="p">)</span>
</code></pre></div></div>

<p><br /></p>

<ul>
  <li>.env</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">CELERY_BROKER_URL</span><span class="o">=</span><span class="s">"amqp://admin:1234@localhost:5672//"</span>
</code></pre></div></div>

<hr />

<h3 id="celery와-rabbitmq실행-개발환경">Celery와 rabbitMQ실행 (개발환경)</h3>

<ul>
  <li>
    <p>django, rabbitmq, celery 서버 3개 모두 실행시킨다</p>
  </li>
  <li>
    <p>celery 실행</p>
  </li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">celery</span> <span class="o">-</span><span class="n">A</span> <span class="n">config</span> <span class="n">worker</span> <span class="o">-</span><span class="n">l</span> <span class="n">info</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">--------------</span> celery@heejung-15Z90N-VR5BK v5.1.2 <span class="o">(</span>sun-harmonics<span class="o">)</span>
<span class="nt">---</span> <span class="k">*****</span> <span class="nt">-----</span> 
<span class="nt">--</span> <span class="k">*******</span> <span class="nt">----</span> Linux-5.11.0-41-generic-x86_64-with-glibc2.29 2021-12-10 13:36:32
- <span class="k">***</span> <span class="nt">---</span> <span class="k">*</span> <span class="nt">---</span> 
- <span class="k">**</span> <span class="nt">----------</span> <span class="o">[</span>config]
- <span class="k">**</span> <span class="nt">----------</span> .&gt; app:         config:0x7fd43406fbb0
- <span class="k">**</span> <span class="nt">----------</span> .&gt; transport:   amqp://admin:<span class="k">**</span>@localhost:5672//
- <span class="k">**</span> <span class="nt">----------</span> .&gt; results:     rpc://
- <span class="k">***</span> <span class="nt">---</span> <span class="k">*</span> <span class="nt">---</span> .&gt; concurrency: 8 <span class="o">(</span>prefork<span class="o">)</span>
<span class="nt">--</span> <span class="k">*******</span> <span class="nt">----</span> .&gt; task events: OFF <span class="o">(</span><span class="nb">enable</span> <span class="nt">-E</span> to monitor tasks <span class="k">in </span>this worker<span class="o">)</span>
<span class="nt">---</span> <span class="k">*****</span> <span class="nt">-----</span> 
 <span class="nt">--------------</span> <span class="o">[</span>queues]
                .&gt; celery           <span class="nv">exchange</span><span class="o">=</span>celery<span class="o">(</span>direct<span class="o">)</span> <span class="nv">key</span><span class="o">=</span>celery
                

<span class="o">[</span>tasks]
  <span class="nb">.</span> config.celery.debug_task
  <span class="nb">.</span> user.tasks.send_email
  <span class="nb">.</span> user.tasks.task_scrappy_daum
  <span class="nb">.</span> user.tasks.task_scrappy_naver

<span class="o">[</span>2021-12-10 13:36:32,764: INFO/MainProcess] Connected to amqp://admin:<span class="k">**</span>@127.0.0.1:5672//
</code></pre></div></div>

<p><br /></p>

<ul>
  <li>rabbitmq 실행</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>rabbitmq-server
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">##  ##      RabbitMQ 3.8.2</span>
  <span class="c">##  ##</span>
  <span class="c">##########  Copyright (c) 2007-2019 Pivotal Software, Inc.</span>
  <span class="c">######  ##</span>
  <span class="c">##########  Licensed under the MPL 1.1. Website: https://rabbitmq.com</span>

  Doc guides: https://rabbitmq.com/documentation.html
  Support:    https://rabbitmq.com/contact.html
  Tutorials:  https://rabbitmq.com/getstarted.html
  Monitoring: https://rabbitmq.com/monitoring.html

  Logs: /var/log/rabbitmq/rabbit@heejung-15Z90N-VR5BK.log
        /var/log/rabbitmq/rabbit@heejung-15Z90N-VR5BK_upgrade.log

  Config file<span class="o">(</span>s<span class="o">)</span>: <span class="o">(</span>none<span class="o">)</span>

  Starting broker... completed with 3 plugins.

</code></pre></div></div>

<p><br /></p>

<ul>
  <li>rabbitmq 종료</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">sudo </span>rabbitmqctl stop
</code></pre></div></div>

<hr />

<h3 id="celery를-이용한-이메일-인증-비동기-처리">Celery를 이용한 이메일 인증 비동기 처리</h3>

<ol>
  <li>회원가입 하는 유저의 이메일 유효성 검증하는 메소드에서 검증이 끝나면 회원가입된 유저의 객체와 유저의 이메일을 반환한다</li>
  <li>이메일 인증을 위해 필요한 유저의 email 정보를 인자로 받아 이메일를 보내는 메서드를 호출해서  인증 링크와 인증 메시지 타이틀을 생성해 메시지를 보낼 유저의 이메일에  shared_task 데코레이터를 붙여 비동기적으로 전송</li>
</ol>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@shared_task</span>
<span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span><span class="n">mail_title</span><span class="p">,</span> <span class="n">message_data</span><span class="p">,</span> <span class="n">mail_to</span><span class="p">):</span>
  <span class="n">email</span> <span class="o">=</span> <span class="n">EmailMessage</span><span class="p">(</span><span class="n">mail_title</span><span class="p">,</span> <span class="n">message_data</span><span class="p">,</span> <span class="n">to</span><span class="o">=</span><span class="p">[</span><span class="n">mail_to</span><span class="p">])</span>
  <span class="n">email</span><span class="o">.</span><span class="n">send</span><span class="p">()</span>
  <span class="k">return</span> <span class="bp">None</span>
</code></pre></div></div>

<hr />

<h3 id="이메일-인증-링크-보내는-과정">이메일 인증 링크 보내는 과정</h3>

<p>회원가입 → 인증 링크 생성 → 이메일에서 클릭 → 리다이렉트</p>

<p>urlsafe_base64 사용 이유 : base64로 암호화 하는 경우 웹으로 전송하는 문자 중 정상적으로 전송되지 않는 문제가 발생하기 때문에 이러한 오류를 막기 위해 safe를 사용</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">user_email</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span>  
        <span class="n">domain</span> <span class="o">=</span> <span class="n">get_current_site</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">domain</span>
        <span class="n">uidb64</span> <span class="o">=</span> <span class="n">urlsafe_base64_encode</span><span class="p">(</span><span class="n">force_bytes</span><span class="p">(</span><span class="n">pk</span><span class="p">))</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">({</span><span class="s">'user_pk'</span> <span class="p">:</span> <span class="n">pk</span><span class="p">},</span> <span class="n">SECRET_KEY</span><span class="p">,</span> <span class="n">ALGORITHM</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">'utf-8'</span><span class="p">)</span>

        <span class="n">message_data</span> <span class="o">=</span> <span class="n">message</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">uidb64</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
        <span class="n">mail_title</span> <span class="o">=</span> <span class="s">'이메일 인증을 완료해주세요'</span>
        <span class="n">mail_to</span> <span class="o">=</span> <span class="n">email</span>
        
        <span class="k">return</span> <span class="p">(</span><span class="n">mail_title</span><span class="p">,</span> <span class="n">message_data</span><span class="p">,</span> <span class="n">mail_to</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">message</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">uidb64</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">f</span><span class="s">"인증에 성공 하셨습니다. :-) 아래 링크 클릭해서 회원가입을 해주세요 ! </span><span class="se">\n</span><span class="s"> http://{domain}/user/account/activate/{uidb64}/{token}"</span>
</code></pre></div></div>

<hr />

<h3 id="이메일-재인증-링크-보내는-과정">이메일 재인증 링크 보내는 과정</h3>

<p>회원가입 → 다른 이메일로 재인증 전송 → 이메일에서 클릭 → 리다이렉트</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">verify_resend_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dto</span><span class="p">:</span><span class="n">ResendDto</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">email</span><span class="o">=</span><span class="n">dto</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">UserService</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">dto</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">dto</span><span class="o">.</span><span class="n">resend_email</span><span class="p">)</span>
            <span class="n">mail</span> <span class="o">=</span> <span class="n">dto</span><span class="o">.</span><span class="n">resend_email</span>

            <span class="k">return</span> <span class="p">{</span><span class="s">"user"</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span> <span class="s">"mail"</span><span class="p">:</span> <span class="n">mail</span><span class="p">,</span> <span class="s">"error"</span><span class="p">:</span><span class="bp">False</span><span class="p">}</span>

        <span class="k">except</span> <span class="n">user</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">context_info</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">"회원가입부터 해주세요"</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">context</span>
</code></pre></div></div>

<hr />

<h3 id="비밀번호-찾기-인증번호-보내는-과정">비밀번호 찾기 인증번호 보내는 과정</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">FindPasswordEmailView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="s">'''
    description: 비밀번호 찾으려는 유저의 이메일 유효성 검증, 검증 후 인증번호 이메일로 발송
    '''</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_ajax</span><span class="p">():</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_vaild_email</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">UserService</span><span class="o">.</span><span class="n">vaildate_user_email</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s">'error'</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

            <span class="n">auth_num</span> <span class="o">=</span> <span class="n">email_auth_num</span><span class="p">()</span>

            <span class="n">result</span><span class="p">[</span><span class="s">'user'</span><span class="p">]</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">auth_num</span>
            <span class="n">result</span><span class="p">[</span><span class="s">'user'</span><span class="p">]</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">context</span> <span class="o">=</span> <span class="n">UserEmailVerifyService</span><span class="o">.</span><span class="n">send_email_with_auth_num</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">auth_num</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_vaild_email</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">VaildEmailDto</span><span class="p">(</span>
            <span class="n">email</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'email'</span><span class="p">)</span>
        <span class="p">)</span>

<span class="k">class</span> <span class="nc">AuthNumConfirmView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="s">'''
    description: 인증번호 유효성 검증, 검증 후 비밀번호 변경 view로 이동
    '''</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">context_info</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">nickname</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="s">'change-password.html'</span><span class="p">,</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_ajax</span><span class="p">():</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_user_confirm_info</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">UserEmailVerifyService</span><span class="o">.</span><span class="n">verify_num</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">[</span><span class="s">'success'</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

            <span class="n">user</span> <span class="o">=</span> <span class="n">UserService</span><span class="o">.</span><span class="n">get_filter_auth_user</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">user</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="s">''</span>
            <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s">'auth'</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">email</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">context_info</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> 

            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_user_confirm_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">UserConfirmDto</span><span class="p">(</span>
            <span class="n">email</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'email'</span><span class="p">),</span>
            <span class="n">valid_num</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'valid_num'</span><span class="p">)</span>
        <span class="p">)</span>

<span class="nd">@method_decorator</span><span class="p">(</span><span class="n">csrf_exempt</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">'dispatch'</span><span class="p">)</span> 
<span class="k">class</span> <span class="nc">ValidChangePwdView</span><span class="p">(</span><span class="n">View</span><span class="p">):</span>
    <span class="s">'''
    description: 변경된 비밀번호 유효성 검증, 검증후 유저의 비밀번호 변경
    '''</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">reset_pwd_form</span> <span class="o">=</span> <span class="n">ChangeSetPwdForm</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">context_info</span><span class="p">(</span><span class="n">forms</span><span class="o">=</span><span class="n">reset_pwd_form</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">'valid-change-pwd.html'</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">is_ajax</span><span class="p">():</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_vaild_pwd_info</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">current_user</span> <span class="o">=</span> <span class="n">UserService</span><span class="o">.</span><span class="n">get_email_user</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">auth</span><span class="p">)</span>
            
            <span class="n">auth_login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>

            <span class="n">reset_pwd_form</span> <span class="o">=</span> <span class="n">ChangeSetPwdForm</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">UserEmailVerifyService</span><span class="o">.</span><span class="n">verify_change_pwd</span><span class="p">(</span><span class="n">reset_pwd_form</span><span class="p">,</span> <span class="n">current_user</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">JsonResponse</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_build_vaild_pwd_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">AuthDto</span><span class="p">(</span>
            <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'auth'</span><span class="p">),</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="p">)</span>

<span class="k">class</span> <span class="nc">LoginCallBackView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">'login_callback.html'</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s">'message'</span><span class="p">:</span> <span class="s">'SUCCESS'</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_to_response</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</code></pre></div></div>

<hr />

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">UserEmailVerifyService</span><span class="p">():</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">send_email_with_auth_num</span><span class="p">(</span><span class="n">email</span><span class="p">,</span> <span class="n">auth_num</span><span class="p">):</span>
        <span class="n">message_data</span> <span class="o">=</span> <span class="n">pwd_change_message</span><span class="p">(</span><span class="n">auth_num</span><span class="p">)</span>
        <span class="n">mail_title</span> <span class="o">=</span> <span class="s">'이메일 인증을 완료해주세요'</span>
        <span class="n">mail_to</span> <span class="o">=</span> <span class="n">email</span>
        <span class="n">send_email</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">mail_title</span><span class="p">,</span> <span class="n">message_data</span><span class="p">,</span> <span class="n">mail_to</span><span class="p">)</span>
        
        <span class="n">context</span> <span class="o">=</span> <span class="n">context_info</span><span class="p">(</span>
        <span class="n">msg</span><span class="o">=</span><span class="s">'이메일에 인증번호를 발송했습니다!'</span><span class="p">,</span> 
        <span class="n">error</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> 
        <span class="n">auth_num</span><span class="o">=</span><span class="n">auth_num</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">context</span>
</code></pre></div></div>

<hr />

<h3 id="celery-beat를-이용해-스크래핑-자동화-처리">Celery Beat를 이용해 스크래핑 자동화 처리</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">celery.schedules</span> <span class="kn">import</span> <span class="n">crontab</span>

<span class="n">app</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">beat_schedule</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'add-every-minutes-naver'</span><span class="p">:{</span>
    <span class="s">'task'</span><span class="p">:</span><span class="s">'user.tasks.task_scrappy_naver'</span><span class="p">,</span>
    <span class="s">'schedule'</span><span class="p">:</span> <span class="n">crontab</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="s">'*/3'</span><span class="p">),</span>
    <span class="p">},</span>
    <span class="s">'add-every-minutes-daum'</span><span class="p">:{</span>
    <span class="s">'task'</span><span class="p">:</span><span class="s">'user.tasks.task_scrappy_daum'</span><span class="p">,</span>
    <span class="s">'schedule'</span><span class="p">:</span> <span class="n">crontab</span><span class="p">(</span><span class="n">minute</span><span class="o">=</span><span class="s">'*/5'</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>

<ul>
  <li>개발환경 실행</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">$</span> <span class="n">celery</span> <span class="o">-</span><span class="n">A</span> <span class="n">config</span> <span class="n">beat</span> <span class="o">-</span><span class="n">l</span> <span class="n">info</span>
</code></pre></div></div>

<hr />

<h3 id="celery--rabbitmq-ec2-서버에서-실행-배포">Celery &amp; RabbitMQ EC2 서버에서 실행 (배포)</h3>

<p><a href="https://docs.celeryproject.org/en/stable/userguide/daemonizing.html#daemonizing">docs.celeryproject.org</a>
데몬으로 돌리기 위해 즉 터미널에서 직접 실행시키지 않아도 알아서 돌아가게 하기 위해서 몇가지의 파일을 작성해야 한다</p>

<ul>
  <li>celery가 사용할 설정 파일</li>
  <li>데몬으로 실행하기 위한 service파일</li>
</ul>

<p><strong>celery 설정 파일</strong>
주의할점: concurrency=8이 default값이지만 ec2 프리티어에서는 작동 안하는 무시한 상황이 벌어짐..</p>

<p><strong>/etc/conf.d/celery</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">CELERYD_NODES</span><span class="o">=</span><span class="s2">"w1"</span>
<span class="nv">CELERY_BIN</span><span class="o">=</span><span class="s2">"/home/ubuntu/myvenv/bin/celery"</span>
<span class="nv">CELERY_APP</span><span class="o">=</span><span class="s2">"config"</span>
<span class="nv">CELERYD_MULTI</span><span class="o">=</span><span class="s2">"multi"</span>
<span class="nv">CELERYD_OPTS</span><span class="o">=</span><span class="s2">"--time-limit=1400 --concurrency=2"</span>

<span class="c"># - %n will be replaced with the first part of the nodename.</span>
<span class="c"># - %I will be replaced with the current child process index</span>
<span class="c">#   and is important when using the prefork pool to avoid race conditions.</span>
<span class="nv">CELERYD_PID_FILE</span><span class="o">=</span><span class="s2">"/var/run/celery/%n.pid"</span>
<span class="nv">CELERYD_LOG_FILE</span><span class="o">=</span><span class="s2">"/var/log/celery/%n%I.log"</span>
<span class="nv">CELERYD_LOG_LEVEL</span><span class="o">=</span><span class="s2">"INFO"</span>

<span class="c"># you may wish to add these options for Celery Beat</span>
<span class="nv">CELERYBEAT_PID_FILE</span><span class="o">=</span><span class="s2">"/var/run/celery/beat.pid"</span>
<span class="nv">CELERYBEAT_LOG_FILE</span><span class="o">=</span><span class="s2">"/var/log/celery/beat.log"</span>

</code></pre></div></div>

<p><br /></p>

<p><strong>services</strong> 파일</p>

<p><strong>/etc/systemd/system/celery.service</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Celery Service
<span class="nv">After</span><span class="o">=</span>network.target

<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>forking
<span class="nv">User</span><span class="o">=</span>ubuntu
<span class="nv">Group</span><span class="o">=</span>ubuntu
<span class="nv">EnvironmentFile</span><span class="o">=</span>/etc/conf.d/celery
<span class="nv">WorkingDirectory</span><span class="o">=</span>/srv/Neo-News
<span class="nv">ExecStart</span><span class="o">=</span>/bin/sh <span class="nt">-c</span> <span class="s1">'${CELERY_BIN} multi start ${CELERYD_NODES} \\
-A ${CELERY_APP} --pidfile=${CELERYD_PID_FILE} \\
--logfile=${CELERYD_LOG_FILE} --loglevel=${CELERYD_LOG_LEVEL} ${CELERYD_OPTS}'</span>
<span class="nv">ExecStop</span><span class="o">=</span>/bin/sh <span class="nt">-c</span> <span class="s1">'${CELERY_BIN} multi stopwait ${CELERYD_NODES} \\
--pidfile=${CELERYD_PID_FILE}'</span>
<span class="nv">ExecReload</span><span class="o">=</span>/bin/sh <span class="nt">-c</span> <span class="s1">'${CELERY_BIN} multi restart ${CELERYD_NODES} \\
-A ${CELERY_APP} --pidfile=${CELERYD_PID_FILE} \\
--logfile=${CELERYD_LOG_FILE} --loglevel=${CELERYD_LOG_LEVEL} ${CELERYD_OPTS}'</span>
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target

</code></pre></div></div>

<p><br /></p>

<p><strong>/etc/systemd/system/celerybeat.service</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Celery Beat Service
<span class="nv">After</span><span class="o">=</span>network.target

<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>simple
<span class="nv">User</span><span class="o">=</span>ubuntu
<span class="nv">Group</span><span class="o">=</span>ubuntu
<span class="nv">EnvironmentFile</span><span class="o">=</span>/etc/conf.d/celery
<span class="nv">WorkingDirectory</span><span class="o">=</span>/srv/Neo-News
<span class="nv">ExecStart</span><span class="o">=</span>/bin/sh <span class="nt">-c</span> <span class="s1">'${CELERY_BIN} -A ${CELERY_APP} beat --pidfile=${CELERYBEAT_PID_FILE} --logfile=${CELERYBEAT_LOG_FILE} --loglevel=${CELERYD_LOG_LEVEL}'</span>
<span class="nv">Restart</span><span class="o">=</span>always
<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target

</code></pre></div></div>

<p><br /></p>

<p><strong>/lib/systemd/system/rabbitmq-server.service</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>RabbitMQ Messaging Server
<span class="nv">After</span><span class="o">=</span>network.target epmd@0.0.0.0.socket
<span class="nv">Wants</span><span class="o">=</span>network.target epmd@0.0.0.0.socket

<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>notify
<span class="nv">User</span><span class="o">=</span>rabbitmq
<span class="nv">SyslogIdentifier</span><span class="o">=</span>rabbitmq
<span class="nv">NotifyAccess</span><span class="o">=</span>all
<span class="nv">TimeoutStartSec</span><span class="o">=</span>3600
<span class="nv">LimitNOFILE</span><span class="o">=</span>65536
<span class="nv">TimeoutStartSec</span><span class="o">=</span>600
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">RestartSec</span><span class="o">=</span>10
<span class="nv">ExecStart</span><span class="o">=</span>/usr/sbin/rabbitmq-server
<span class="nv">ExecStop</span><span class="o">=</span>/usr/sbin/rabbitmqctl stop

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target

</code></pre></div></div>

<hr />

<h3 id="service파일-구동">service파일 구동</h3>

<ul>
  <li>sudo systemctl restart celery.service # service파일 재시작</li>
  <li>sudo systemctl start celery.service # service파일 시작</li>
  <li>sudo systemctl status celery.service # service 상태</li>
  <li>sudo systemctl stop celery.service # service 중지</li>
</ul>

<p><br /></p>

<h3 id="실제로-celery가-돌아가면-동작되는-log를-볼-수-있다">실제로 Celery가 돌아가면 동작되는 log를 볼 수 있다</h3>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/var/log/celery/
</code></pre></div></div>

<p><br /></p>

<p>beat가 돌아간 함수, 시간, 날짜를 볼 수 있다</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>beat.log

</code></pre></div></div>

<p><br /></p>

<p>worker가 돌아간 함수, 시간, 날짜를 볼 수 있다. <strong>beat가 돌아가는 함수와 worker를 공유해서 쓰기 때문에 스크래핑 되는 로그와 이메일 인증시 동작되는 로그가 함께 보인다.</strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cat </span>w1-1.log

</code></pre></div></div>

                </div>
<!--                -->
<!--                -->
<!--                <span class="tag">celery</span>-->
<!--                -->
<!--                -->
            </section>
        
        <div id="post-disqus" class="container">
            <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = 'https://heejung-gjt-github-io.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        </div>
        



    </div>
</main>

        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://heejung-gjt.github.io/">studying developer</a> &copy; 2021</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://github.com/heejung-gjt" target="_blank" rel="noopener">heejung's GitHub Pages</a>
<!--                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener"></a>-->
                </section>
                <nav class="site-footer-nav">
<!--                    <a href="/">Latest Posts</a>-->
                    
                    
                    <a href="https://heejung-gjt.github.io" target="_blank" rel="noopener">github blog</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    
        <div id="subscribe" class="subscribe-overlay">
            <a class="subscribe-overlay-close" href="#"></a>
            <div class="subscribe-overlay-content">
                
                <h1 class="subscribe-overlay-title">Subscribe to studying developer</h1>
                <p class="subscribe-overlay-description">Stay up to date! Get all the latest &amp; greatest posts delivered straight to your inbox</p>
<!--                <!--
<form method="post" action="/subscribe/" class="">
    <input class="confirm" type="hidden" name="confirm"  /><input class="location" type="hidden" name="location"  /><input class="referrer" type="hidden" name="referrer"  />

    <div class="form-group">
        <input class="subscribe-email" type="email" name="email"  placeholder="youremail@example.com" />
    </div>
    <button class="" type="submit" disabled><span>Subscribe</span></button>
    <script type="text/javascript">(function(g,h,o,s,t){h[o]('.location')[s]=h[o]('.location')[s] || g.location.href;h[o]('.referrer')[s]=h[o]('.referrer')[s] || h.referrer;})(window,document,'querySelector','value');</script>
</form>
-->-->
            </div>
        </div>
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'G-LESPMGXKR3', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->
    <script id="dsq-count-scr" src="//heejung-gjt-github-io.disqus.com/count.js" async></script>
</body>
</html>
